org: diegoladrondeg
service: api-gestion-pedidos

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  memorySize: 1024
  timeout: 60
  role: arn:aws:iam::010160578866:role/LabRole

  environment:
    DYNAMODB_TABLE_USERS: ${self:custom.usersTableName.${self:provider.stage}}
    DYNAMODB_TABLE_PEDIDOS: ${self:custom.pedidosTableName.${self:provider.stage}}
    DYNAMODB_TABLE_PRODUCTOS: ${self:custom.productosTableName.${self:provider.stage}}
    DYNAMODB_TABLE_ESTADOS: ${self:custom.estadoPedidosTableName.${self:provider.stage}}
    DYNAMODB_TABLE_LOGS: ${self:custom.logsTableName.${self:provider.stage}}
    DYNAMODB_TABLE_CONNECTIONS: ${self:custom.connectionsTableName.${self:provider.stage}}
    DYNAMODB_TABLE_RESTAURANTES: ${self:custom.restaurantesTableName.${self:provider.stage}}  # Nueva tabla de Restaurantes
    STAGE: ${self:provider.stage}

# --- Funciones Lambda ---
functions:
  # Funciones HTTP para CRUD
  createLog:
    handler: src/createLog.lambda_handler
    events:
      - http:
          path: /logs
          method: post
          cors: true

  createPedido:
    handler: src/createPedido.lambda_handler
    events:
      - http:
          path: /pedidos
          method: post
          cors: true

  getEstadoPedido:
    handler: src/getEstadoPedido.lambda_handler
    events:
      - http:
          path: /pedidos/{pedido_id}/estado
          method: get
          cors: true

  listPedidosActivos:
    handler: src/listPedidosActivos.lambda_handler
    events:
      - http:
          path: /pedidos/activos
          method: get
          cors: true

  # Funciones HTTP para autenticación
  login:
    handler: src/login.lambda_handler
    events:
      - http:
          path: /login
          method: post
          cors: true

  register:
    handler: src/register.lambda_handler
    events:
      - http:
          path: /register
          method: post
          cors: true

  # Funciones HTTP para restaurantes
  registerRestaurant:
    handler: src/registerRestaurant.lambda_handler
    events:
      - http:
          path: /restaurantes/register
          method: post
          cors: true

  loginRestaurant:
    handler: src/loginRestaurant.lambda_handler
    events:
      - http:
          path: /restaurantes/login
          method: post
          cors: true

  # Función para notificar cambios de estado de pedido
  notifyPedidoEstado:
    handler: src/notifyPedidoEstado.lambda_handler
    events:
      - http:
          path: /pedidos/{pedido_id}/estado
          method: put
          cors: true

  # Funciones para manejar el estado de un pedido
  updateEstadoPedido:
    handler: src/updateEstadoPedido.lambda_handler
    events:
      - http:
          path: /pedidos/{pedido_id}/estado
          method: put
          cors: true
          timeout: 60
# --- Nombres Personalizados (Custom) ---
custom:
  usersTableName:
    dev: ${self:service}-dev-users
    test: ${self:service}-test-users
    prod: ${self:service}-prod-users

  pedidosTableName:
    dev: ${self:service}-dev-pedidos
    test: ${self:service}-test-pedidos
    prod: ${self:service}-prod-pedidos

  productosTableName:
    dev: ${self:service}-dev-productos
    test: ${self:service}-test-productos
    prod: ${self:service}-prod-productos

  estadoPedidosTableName:
    dev: ${self:service}-dev-estado-pedidos
    test: ${self:service}-test-estado-pedidos
    prod: ${self:service}-prod-estado-pedidos

  logsTableName:
    dev: ${self:service}-dev-logs
    test: ${self:service}-test-logs
    prod: ${self:service}-prod-logs

  connectionsTableName:
    dev: ${self:service}-dev-connections
    test: ${self:service}-test-connections
    prod: ${self:service}-prod-connections

  restaurantesTableName:
    dev: ${self:service}-dev-restaurantes   # Nueva tabla para Restaurantes
    test: ${self:service}-test-restaurantes
    prod: ${self:service}-prod-restaurantes

# --- Recursos Adicionales (DynamoDB y WebSocket) ---
resources:
  Resources:
    # Tablas DynamoDB
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.usersTableName.${self:provider.stage}}
        AttributeDefinitions:
          - AttributeName: user_id
            AttributeType: S
        KeySchema:
          - AttributeName: user_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    PedidosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.pedidosTableName.${self:provider.stage}}
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: pedido_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: pedido_id
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    ProductosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.productosTableName.${self:provider.stage}}
        AttributeDefinitions:
          - AttributeName: producto_id
            AttributeType: S
        KeySchema:
          - AttributeName: producto_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    EstadoPedidosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.estadoPedidosTableName.${self:provider.stage}}
        AttributeDefinitions:
          - AttributeName: pedido_id
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: pedido_id
            KeyType: HASH
          - AttributeName: timestamp
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    LogsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.logsTableName.${self:provider.stage}}
        AttributeDefinitions:
          - AttributeName: log_id
            AttributeType: S
        KeySchema:
          - AttributeName: log_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    ConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.connectionsTableName.${self:provider.stage}}
        AttributeDefinitions:
          - AttributeName: connection_id
            AttributeType: S
        KeySchema:
          - AttributeName: connection_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

RestaurantesTable:  # Nueva tabla para Restaurantes sin índices secundarios
  Type: AWS::DynamoDB::Table
  Properties:
    TableName: ${self:custom.restaurantesTableName.${self:provider.stage}}
    AttributeDefinitions:
      - AttributeName: restaurant_id
        AttributeType: S  # Define la clave primaria como 'restaurant_id' (string)
      - AttributeName: email
        AttributeType: S  # Asegúrate de que el 'email' esté definido como un atributo normal
    KeySchema:
      - AttributeName: restaurant_id
        KeyType: HASH  # Usamos 'restaurant_id' como la clave primaria (HASH key)
    BillingMode: PAY_PER_REQUEST

